name: Backend CI/CD (NestJS to Firebase Functions)

on:
  push:
    branches:
      - main # Altere para o nome da sua branch principal, se necessÃ¡rio
    paths:
      - 'backend/**' # Gatilho apenas quando houver mudanÃ§as na pasta 'backend'

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend # Define o diretÃ³rio de trabalho para a pasta 'backend'

    steps:
      - name: Checkout do CÃ³digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Use a versÃ£o do Node.js compatÃ­vel com seu NestJS/Firebase Functions

      - name: Instalar DependÃªncias
        run: npm install

      # - name: ğŸ§ª Executar Testes UnitÃ¡rios e de IntegraÃ§Ã£o
      #   # Este passo Ã© CRÃTICO. Se os testes falharem, o workflow para.
      #   run: npm run test:cov # Assumindo que vocÃª tem um script 'test:cov' que executa todos os testes
      #   env:
      #     # VariÃ¡veis de ambiente de teste, se necessÃ¡rio
      #     NODE_ENV: test

      - name: ğŸš€ Deploy para Firebase Functions
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          # O token de serviÃ§o que vocÃª configurou no GitHub Secrets
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          projectId: 'helpdocs-46d7f' # <-- MUDAR: ID do seu projeto Firebase
          channelId: 'live'
          target: 'functions' # Alvo especÃ­fico para o deploy do backend
          entryPoint: './backend' # O ponto de entrada onde o firebase.json estÃ¡ (se for necessÃ¡rio)

      - name: Notificar Sucesso
        if: success()
        run: echo "Deploy do Backend realizado com sucesso!"

      - name: Notificar Falha
        if: failure()
        run: echo "Falha no deploy do Backend. Verifique os logs de teste."
